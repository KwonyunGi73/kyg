# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: AI-Powered README Update with Gemini

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ (main ë¸Œëœì¹˜ë¡œ Pull Requestê°€ Merged ë˜ì—ˆì„ ë•Œ)
on:
  pull_request:
    types: [closed]

jobs:
  update-readme:
    # PRì´ ë³‘í•©(merged)ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    
    # ìš°ë¶„íˆ¬ ìµœì‹  ê°€ìƒ í™˜ê²½ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    # ì›Œí¬í”Œë¡œìš°ê°€ ë¦¬í¬ì§€í† ë¦¬ ë‚´ìš©ì„ ìˆ˜ì •í•˜ê³  ì»¤ë°‹í•  ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ë¶€ì—¬
    permissions:
      contents: write

    steps:
      # 1. í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ (í•„ìˆ˜ ë‹¨ê³„)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. íŒŒì´ì¬ í™˜ê²½ ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12' # ì‚¬ìš©í•˜ì‹œëŠ” íŒŒì´ì¬ ë²„ì „ì— ë§ê²Œ

      # 3. íŒŒì´ì¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ (Gemini API ì‚¬ìš©ì„ ìœ„í•´)
      - name: Install dependencies
        run: pip install google-generativeai

      # 4. Gemini AI ìš”ì•½ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Generate summary with Gemini script
        id: gemini_summary # ì´ ìŠ¤í…ì˜ ID
        run: |
          # ai_summary.pyë¥¼ ì‹¤í–‰í•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ GITHUB_OUTPUTì— ì €ì¥
          # ì—¬ëŸ¬ ì¤„ì˜ ê²°ê³¼ë„ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ íŠ¹ìˆ˜í•œ í˜•ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          python ai_summary.py >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          # ê¹ƒí—ˆë¸Œ Secretsì— ì €ì¥í•œ API í‚¤ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ìŠ¤í¬ë¦½íŠ¸ì— ì „ë‹¬
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}

      # 5. AIê°€ ìƒì„±í•œ ìš”ì•½ ë‚´ìš©ì„ README íŒŒì¼ì˜ ë§¨ ìœ„ì— ì¶”ê°€
      - name: Update README.md
        run: |
          # 4ë‹¨ê³„ì—ì„œ ì €ì¥í•œ ìš”ì•½ ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
          SUMMARY="${{ steps.gemini_summary.outputs.summary }}"

          # ê¸°ì¡´ README íŒŒì¼ì´ ìˆë‹¤ë©´ ë°±ì—…
          if [ -f README.md ]; then
            mv README.md README.md.bak
          else
            touch README.md.bak
          fi
          
          # ìƒˆë¡œìš´ ë‚´ìš©ì„ ë‹´ì€ README.md íŒŒì¼ ìƒì„±
          echo "## ğŸš€ AIê°€ ìš”ì•½í•œ ìµœê·¼ ë³€ê²½ ì‚¬í•­" > README.md
          echo "" >> README.md
          echo "$SUMMARY" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          # ë°±ì—…í•´ë‘” ê¸°ì¡´ README ë‚´ìš©ê³¼ í•©ì¹˜ê¸°
          cat README.md.bak >> README.md
          # ì„ì‹œ ë°±ì—… íŒŒì¼ ì‚­ì œ
          rm README.md.bak

      # 6. ë³€ê²½ëœ README.md íŒŒì¼ì„ ìë™ìœ¼ë¡œ ì»¤ë°‹í•˜ê³  í‘¸ì‹œ
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: AIê°€ README ìë™ ì—…ë°ì´íŠ¸"
          file_pattern: README.md
          # ì•„ë˜ ë‘ ì¤„ì„ ì¶”ê°€í•˜ì—¬ ì»¤ë°‹í•˜ëŠ” ì‚¬ìš©ì ì •ë³´ë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
          commit_user_name: GitHub Actions [bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com